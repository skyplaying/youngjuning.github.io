<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta name="title" content="洛竹的官方网站" />
    <meta name="keywords" content="react, javascript, typescript" />
    <meta name="description" content="怕什么真理无穷，进一寸有一寸的欢喜" />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="https://i.loli.net/2021/01/07/LkH3VM6oBnIuFNi.png"
    />
    <link rel="stylesheet" href="/umi.26fedac2.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.3.9
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.includes(e) ? e : r[0]
        );
      })();
    </script>
    <title>Deno GitHub Action 源码解析</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/blog/deno/deno git-hub action 源码解析" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;https://i.loli.net/2021/01/07/LkH3VM6oBnIuFNi.png&#x27;)" href="/">洛竹的官方网站</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a aria-current="page" class="active" href="/blog">博客</a></span><span><a href="/awesome">收藏</a></span><span><a href="/about">关于</a></span><span><a href="/leetcode">算法</a></span><span><a href="/links">友链</a></span><span>洛竹文档⤵️<ul><li><a href="/cobra"> Cobra</a></li><li><a href="/viper"> Viper</a></li><li><a href="/github-actions"> GitHub Actions</a></li></ul></span><span><a target="_blank" rel="noopener noreferrer" href="https://juejin.cn/user/325111174662855/posts">掘金<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><span><a target="_blank" rel="noopener noreferrer" href="https://www.zhihu.com/people/yangjunning">知乎<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><ul><li><a target="_blank" rel="noopener noreferrer" href="https://www.zhihu.com/column/c_1341734653628149760">前端早茶馆<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/youngjuning/youngjuning.github.io">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;https://i.loli.net/2021/01/07/LkH3VM6oBnIuFNi.png&#x27;)" href="/"></a><h1>洛竹的官方网站</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a aria-current="page" class="active" href="/blog">博客</a></li><li><a href="/awesome">收藏</a></li><li><a href="/about">关于</a></li><li><a href="/leetcode">算法</a></li><li><a href="/links">友链</a></li><li>洛竹文档⤵️<ul><li><a href="/cobra"> Cobra</a></li><li><a href="/viper"> Viper</a></li><li><a href="/github-actions"> GitHub Actions</a></li></ul></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.cn/user/325111174662855/posts">掘金<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.zhihu.com/people/yangjunning">知乎<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><ul><li><a target="_blank" rel="noopener noreferrer" href="https://www.zhihu.com/column/c_1341734653628149760">前端早茶馆<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/youngjuning/youngjuning.github.io">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/blog">Less is more</a></li><li><a aria-current="page" class="active" href="/blog/deno">Deno</a><ul><li><a aria-current="page" class="active" href="/blog/deno/deno git-hub action 源码解析"><span>Deno GitHub Action 源码解析</span></a></li><li><a href="/blog/deno/向 deno 学习脚本的管理"><span>向 Deno 学习脚本的管理</span></a></li></ul></li><li><a href="/blog/devops">Devops</a><ul><li><a href="/blog/devops/玩转 github actions"><span>玩转 GitHub Actions</span></a></li></ul></li><li><a href="/blog/go">Go</a><ul><li><a href="/blog/go/go语法学习笔记"><span>Go 语法学习笔记</span></a></li><li><a href="/blog/go/基于 go 实现 deno upgrade"><span>基于 Go 实现 Deno upgrade</span></a></li><li><a href="/blog/go/极速入门 go 并爬取掘金专栏"><span>极速入门 Go 并爬取掘金专栏</span></a></li></ul></li><li><a href="/blog/javascript">Javascript</a><ul><li><a href="/blog/javascript/使用jest和enzyme进行react native单元测试"><span>使用Jest和Enzyme进行React Native单元测试</span></a></li><li><a href="/blog/javascript/图解google-v8-学习笔记"><span>图解 Google V8 学习笔记</span></a></li></ul></li><li><a href="/blog/others">Others</a><ul><li><a href="/blog/others/程序员购钻指南"><span>程序员购钻指南：钻戒值不值得买？怎么买？</span></a></li></ul></li><li><a href="/blog/react-native">react-native</a><ul><li><a href="/blog/react-native/flutter-vs-react-native–what-to-choose-in-2021"><span>2021 Flutter 完胜 React Native ?</span></a></li><li><a href="/blog/react-native/react native 调试最佳实践"><span>React Native 调试最佳实践</span></a></li><li><a href="/blog/react-native/当我们在聊 rn 时，我们在谈什么"><span>当我们在聊 RN 时，我们在聊什么|技术点评</span></a></li><li><a href="/blog/react-native/给 react native 库添加 example"><span>给 React Native 库添加 Example</span></a></li></ul></li><li><a href="/blog/rust">Rust</a><ul><li><a href="/blog/rust/一个番茄钟入门 rust"><span>一个番茄钟入门 Rust</span></a></li><li><a href="/blog/rust/rust 语法学习"><span>Rust 语法学习</span></a></li><li><a href="/blog/rust/rust 编写猜数游戏"><span>Rust 编写猜数游戏</span></a></li><li><a href="/blog/rust/为什么rust需要局部变量隐藏"><span>为什么 Rust 需要局部变量隐藏</span></a></li><li><a href="/blog/rust/rust 在 web 领域的应用"><span>Rust 在 Web 领域的应用</span></a></li></ul></li><li><a href="/blog/tools">Tools</a><ul><li><a href="/blog/tools/发布一个 homebrew 包"><span>发布一个 Homebrew 包</span></a></li><li><a href="/blog/tools/我的mac开发环境"><span>我的 Mac 开发环境</span></a></li></ul></li><li><a href="/blog/typescript">Typescript</a><ul><li><a href="/blog/typescript/向微软官方贡献 @types 包"><span>向微软官方贡献 @types 包</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="Action 结构" data-depth="2"><a href="/blog/deno/deno git-hub action 源码解析#action-结构"><span>Action 结构</span></a></li><li title="build job" data-depth="2"><a href="/blog/deno/deno git-hub action 源码解析#build-job"><span>build job</span></a></li><li title="strategy 策略" data-depth="2"><a href="/blog/deno/deno git-hub action 源码解析#strategy-策略"><span>strategy 策略</span></a></li><li title="env 环境变量" data-depth="2"><a href="/blog/deno/deno git-hub action 源码解析#env-环境变量"><span>env 环境变量</span></a></li><li title="steps 步骤" data-depth="2"><a href="/blog/deno/deno git-hub action 源码解析#steps-步骤"><span>steps 步骤</span></a></li><li title="1、Configure git" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#1、configure-git"><span>1、Configure git</span></a></li><li title="2、Clone repository" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#2、clone-repository"><span>2、Clone repository</span></a></li><li title="3、Create source tarballs (release, linux)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#3、create-source-tarballs-release-linux"><span>3、Create source tarballs (release, linux)</span></a></li><li title="4、Install rust" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#4、install-rust"><span>4、Install rust</span></a></li><li title="5、Install clippy and rustfmt" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#5、install-clippy-and-rustfmt"><span>5、Install clippy and rustfmt</span></a></li><li title="6、Install Deno（非 Windows）" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#6、install-deno（非-windows）"><span>6、Install Deno（非 Windows）</span></a></li><li title="7、Install Deno (Windows)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#7、install-deno-windows"><span>7、Install Deno (Windows)</span></a></li><li title="8、Install Python" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#8、install-python"><span>8、Install Python</span></a></li><li title="9、Install Node" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#9、install-node"><span>9、Install Node</span></a></li><li title="10、Remove unused versions of Python" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#10、remove-unused-versions-of-python"><span>10、Remove unused versions of Python</span></a></li><li title="11、Setup gcloud (unix)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#11、setup-gcloud-unix"><span>11、Setup gcloud (unix)</span></a></li><li title="12、Setup gcloud (windows)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#12、setup-gcloud-windows"><span>12、Setup gcloud (windows)</span></a></li><li title="13、Configure canary build" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#13、configure-canary-build"><span>13、Configure canary build</span></a></li><li title="14、Log versions" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#14、log-versions"><span>14、Log versions</span></a></li><li title="15、lint.js" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#15、lintjs"><span>15、lint.js</span></a></li><li title="16、test_format.js" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#16、test_formatjs"><span>16、test_format.js</span></a></li><li title="17、Build release" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#17、build-release"><span>17、Build release</span></a></li><li title="18、Build debug" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#18、build-debug"><span>18、Build debug</span></a></li><li title="19、Pre-release (linux)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#19、pre-release-linux"><span>19、Pre-release (linux)</span></a></li><li title="20、Pre-release (mac)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#20、pre-release-mac"><span>20、Pre-release (mac)</span></a></li><li title="21、Pre-release (windows)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#21、pre-release-windows"><span>21、Pre-release (windows)</span></a></li><li title="22、Upload canary to dl.deno.land (unix)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#22、upload-canary-to-dldenoland-unix"><span>22、Upload canary to dl.deno.land (unix)</span></a></li><li title="23、Upload canary to dl.deno.land (windows)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#23、upload-canary-to-dldenoland-windows"><span>23、Upload canary to dl.deno.land (windows)</span></a></li><li title="24、Test release" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#24、test-release"><span>24、Test release</span></a></li><li title="25、Test debug" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#25、test-debug"><span>25、Test debug</span></a></li><li title="26、Configure hosts file for WPT (unix)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#26、configure-hosts-file-for-wpt-unix"><span>26、Configure hosts file for WPT (unix)</span></a></li><li title="27、Configure hosts file for WPT (windows)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#27、configure-hosts-file-for-wpt-windows"><span>27、Configure hosts file for WPT (windows)</span></a></li><li title="28、Run web platform tests (release)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#28、run-web-platform-tests-release"><span>28、Run web platform tests (release)</span></a></li><li title="29、Run web platform tests (debug)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#29、run-web-platform-tests-debug"><span>29、Run web platform tests (debug)</span></a></li><li title="30、Run Benchmarks" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#30、run-benchmarks"><span>30、Run Benchmarks</span></a></li><li title="31、Post Benchmarks" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#31、post-benchmarks"><span>31、Post Benchmarks</span></a></li><li title="32、Worker info" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#32、worker-info"><span>32、Worker info</span></a></li><li title="33、Upload release to dl.deno.land (unix)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#33、upload-release-to-dldenoland-unix"><span>33、Upload release to dl.deno.land (unix)</span></a></li><li title="34、Upload release to dl.deno.land (windows)" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#34、upload-release-to-dldenoland-windows"><span>34、Upload release to dl.deno.land (windows)</span></a></li><li title="35、Upload release to GitHub" data-depth="3"><a href="/blog/deno/deno git-hub action 源码解析#35、upload-release-to-github"><span>35、Upload release to GitHub</span></a></li></ul><div class="__dumi-default-layout-content"><span class="__dumi-default-badge">掘金专栏</span><div style="display:flex;justify-content:center"><img src="https://i.loli.net/2021/02/08/7zuiSw9tadnoQLU.png" width="70%"/></div><div class="markdown"><p>GitHub Action 是 GitHub 官方的 CI/CD 工具，相较于 Travis CI 和 Circle CI，更轻量和易于扩展，<a target="_blank" rel="noopener noreferrer" href="https://github.com/marketplace?type=actions">marketplace<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中有大量社区贡献的插件。各大开源项目都纷纷转向使用 GitHub Action 作为持续集成的工具，比如本文的主角 Deno。</p><p>GitHub 的文档中有很多概念写的十分晦涩，有些翻译很僵硬影响理解。截止发稿时，Deno 的 <a target="_blank" rel="noopener noreferrer" href="https://github.com/youngjuning/deno/blob/master/.github/workflows/ci.yml">ci.yml<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文件有 323 行，是一个很好的学习范本。想要对 GitHub Action 有个了解或对 Deno 的持续集成部分感兴趣的同学都可以一起来探究下。</p><h2 id="action-结构"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#action-结构"><span class="icon icon-link"></span></a>Action 结构</h2><blockquote><p>注意：GitHub Action 的 ci 脚本需要放在 <code>.github/workflows</code> 文件夹下</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> ci</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">push</span><span class="token punctuation">,</span><span class="token plain"> pull_request</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li><code>name</code>：工作流程的名称。GitHub 在仓库的操作页面上显示工作流程的名称。如果省略 name，GitHub 将其设置为相对于仓库根目录的工作流程文件路径。</li><li><code>on</code>：必填。是<a target="_blank" rel="noopener noreferrer" href="https://docs.github.com/cn/articles/events-that-trigger-workflows">触发工作流程的事件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。Deno 中 的 <code>[push,pull_request]</code> 代表有主分支有提交代码或 pull_request 时触发 CI 流程。</li><li><code>jobs</code>：工作流程运行包括一项或多项作业。作业默认是并行运行。Deno 中只有一个 job —— <code>build</code></li></ul><h2 id="build-job"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#build-job"><span class="icon icon-link"></span></a>build job</h2><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token key atrule">jobs</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> matrix.kind </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> matrix.os </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">      github.event_name == &#x27;push&#x27; ||</span></div><div class="token-line"><span class="token scalar string">      !startsWith(github.event.pull_request.head.label, &#x27;denoland:&#x27;)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> matrix.os </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">timeout-minutes</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">60</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>`name：作业显示在 GitHub 上的名称。<ul><li><code>matrix</code>：用于访问为当前作业配置的矩阵参数。例如，Deno 使用 kind 和 os 版本配置矩阵构建，matrix 上下文对象将包含当前作业的 kind 和 os 版本。</li></ul></li><li><code>if</code>：您可以使用 if 条件阻止作业在条件得到满足之前运行。Deno 中判断 <code>github.event_name</code> 等于 <code>&quot;push&quot;</code> 或 <code>label</code> 以 <code>&quot;denoland:&quot;</code> 开头的 <code>pull_request</code> 事件</li><li><code>runs-on</code>：<strong>必填</strong>。 任务运行的机器。机器可以是 GitHub 托管的运行器或自托管的运行器。定义操作系统矩阵时，必须将 <code>runs-on</code> 的值设置为您定义的 <code>matrix.os</code> 上下文属性。Deno 是跨平台的，因此创建了矩阵以在多个运行器操作系统上运行构建工作流程。</li><li><code>timeout-minutes</code>: 在 GitHub 自动取消运行之前可让作业运行的最大分钟数。 默认值：360。Deno 中设置为 60 来尽早暴露问题。</li><li><code>strategy</code>：策略，用于创建作业的构建矩阵。您可以定义要在其中运行每项作业的不同变种。这可能不太好理解，在 Deno 中，其实就是为了同时构建出多个平台的产物。后面的章节我们单独解析 Deno 中具体的应用。</li><li><code>env</code>：环境变量的 <code>map</code> 可用于作业中的所有步骤。 您也可以设置整个工作流程或单个步骤的环境变量。后面章节我们单独解析 Deno 中具体的应用。</li><li><code>steps</code>：作业包含一系列任务，称为 steps。步骤可以运行命令、运行设置任务，或者运行您的仓库、公共仓库中的操作或 Docker 注册表中发布的操作。后面章节我们单独解析 Deno 中具体的应用。</li></ul><h2 id="strategy-策略"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#strategy-策略"><span class="icon icon-link"></span></a>strategy 策略</h2><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token key atrule">strategy</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">matrix</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">include</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">os</span><span class="token punctuation">:</span><span class="token plain"> macos</span><span class="token punctuation">-</span><span class="token number">10.15</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation">:</span><span class="token plain"> test_release</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">os</span><span class="token punctuation">:</span><span class="token plain"> windows</span><span class="token punctuation">-</span><span class="token number">2019</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation">:</span><span class="token plain"> test_release</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">os</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> github.repository == &#x27;denoland/deno&#x27; </span><span class="token important">&amp;&amp;</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">latest&#x27; </span><span class="token punctuation">|</span><span class="token punctuation">|</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">18.04&#x27; </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation">:</span><span class="token plain"> test_release</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">os</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> github.repository == &#x27;denoland/deno&#x27; </span><span class="token important">&amp;&amp;</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">latest&#x27; </span><span class="token punctuation">|</span><span class="token punctuation">|</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">18.04&#x27; </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation">:</span><span class="token plain"> test_debug</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">os</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> github.repository == &#x27;denoland/deno&#x27; </span><span class="token important">&amp;&amp;</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">latest&#x27; </span><span class="token punctuation">|</span><span class="token punctuation">|</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">18.04&#x27; </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation">:</span><span class="token plain"> bench</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">os</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> github.repository == &#x27;denoland/deno&#x27; </span><span class="token important">&amp;&amp;</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">latest&#x27; </span><span class="token punctuation">|</span><span class="token punctuation">|</span><span class="token plain"> &#x27;ubuntu</span><span class="token punctuation">-</span><span class="token plain">18.04&#x27; </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation">:</span><span class="token plain"> lint</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># Always run master branch builds to completion. This allows the cache to</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># stay mostly up-to-date in situations where a single job fails due to</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># e.g. a flaky test.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># Don&#x27;t fast-fail on tag build because publishing binaries shouldn&#x27;t be</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># prevented if &#x27;cargo publish&#x27; fails (which can be a false negative).</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">fail-fast</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> github.event_name == &#x27;pull_request&#x27; </span><span class="token punctuation">|</span><span class="token punctuation">|</span><span class="token plain"> (github.ref </span><span class="token tag">!=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    &#x27;refs/heads/master&#x27; </span><span class="token important">&amp;&amp;</span><span class="token plain"> </span><span class="token tag">!startsWith(github.ref</span><span class="token punctuation">,</span><span class="token plain"> &#x27;refs/tags/&#x27;)) </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li><code>strategy</code>：策略会为您的工作创建构建矩阵。您可以定义不同的变体来运行每个作业。这可能不太好理解，在 Deno 中，其实就是为了同时构建出多个平台的产物。<ul><li><code>matrix</code>：您可以定义不同作业配置的矩阵。Deno 中定义了 6 个矩阵。它们分别用来执行测试、调试、压测、lint 等工作<ul><li><code>include</code>：使用 <code>matrix</code> 只能定义使用某个 os，没办法添加其他配置。用 <code>include</code> 可以解决这个问题</li></ul></li><li><code>fail-fast</code>：设置为 <code>true</code> 时，如果任何 <code>matrix</code> 作业失败，GitHub 将取消所有进行中的作业。 默认值：<code>true</code>。ry 在这个 <a target="_blank" rel="noopener noreferrer" href="https://github.com/denoland/deno/commit/46d5843f753548415c87f3c8a868bba49c203b92#diff-b803fcb7f17ed9235f1e5cb1fcd2f5d3b2838429d4368ae4c57ce4436577f03f">commit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中删除了 <code>cargo publish</code>，从注释中看来这里的 <code>fail-fast</code> 配置已经是冗余的了，我顺手就是一个 fork、commit、<a target="_blank" rel="noopener noreferrer" href="https://github.com/denoland/deno/pull/9449">pr<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 三连。</li></ul></li></ul><p><strong>插曲</strong></p><p><code>$<!-- -->{<!-- -->{<!-- --> github.repository == &#x27;denoland/deno&#x27; &amp;&amp; &#x27;ubuntu-latest&#x27; || &#x27;ubuntu-18.04&#x27; <!-- -->}<!-- -->}</code> 这种写法我看到时很疑惑，直接取 &#x27;ubuntu-latest&#x27; 不行吗？如果不行是为什么呢？抱着求真的态度，我翻阅到是在这个 <a target="_blank" rel="noopener noreferrer" href="https://github.com/denoland/deno/commit/1a27c19c583fa6bd1eaaec93b513bfbac37fc53c#diff-b803fcb7f17ed9235f1e5cb1fcd2f5d3b2838429d4368ae4c57ce4436577f03f">commit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 加入的这个判断，在一番询问后得到了下面的答案：</p><p><img src="https://i.loli.net/2021/02/08/j5svP8J1MRKAyph.png" alt=""/></p><p>在 justjavac 大佬那里也得到了印证：</p><p><img src="https://i.loli.net/2021/02/08/MlHJzdtAnRIYZ7f.png" alt=""/></p><p>然后我还有个疑问是为什么不使用三元表达式，是 YAML 语法不支持吗？</p><blockquote><p>也许是我语法不对，按照 JS 的经验不管用，有知道的大佬可以评论教学一下！</p></blockquote><p><img src="https://i.loli.net/2021/02/08/TJPGLce39bKSY5n.png" alt=""/></p><h2 id="env-环境变量"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#env-环境变量"><span class="icon icon-link"></span></a>env 环境变量</h2><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">CARGO_INCREMENTAL</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">RUST_BACKTRACE</span><span class="token punctuation">:</span><span class="token plain"> full</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">CARGO_TERM_COLOR</span><span class="token punctuation">:</span><span class="token plain"> always</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li><code>env</code>：环境变量的 <code>map</code> 可用于作业中的所有步骤。您也可以设置整个工作流程或单个步骤的环境变量。代码中的三个变量是整个流程的环境变量。<ul><li><code>CARGO_INCREMENTAL</code>、<code>CARGO_TERM_COLOR</code>、<code>RUST_BACKTRACE</code> 是配置给 Cargo 用的，具体的参考<a target="_blank" rel="noopener noreferrer" href="https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-reads">environment-variables-cargo-reads<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这里不展开解读了。</li></ul></li></ul><h2 id="steps-步骤"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#steps-步骤"><span class="icon icon-link"></span></a>steps 步骤</h2><p>Deno 的 CI 中截止写下这段话时有 35 个步骤，相当考验我继续解读的勇气。。。</p><blockquote><p>作业包含一系列任务，称为 <code>steps</code>。步骤可以运行命令、运行设置任务，或者运行您的仓库、公共仓库中的操作或 Docker 注册表中发布的操作。并非所有步骤都会运行操作，但所有操作都会作为步骤运行。每个步骤在运行器环境中以其自己的进程运行，且可以访问工作区和文件系统。因为步骤以自己的进程运行，所以步骤之间不会保留环境变量的更改。 GitHub 提供内置的步骤来设置和完成作业。—— 文档</p></blockquote><h3 id="1、configure-git"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#1、configure-git"><span class="icon icon-link"></span></a>1、Configure git</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Configure git</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> git config </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">global core.symlinks true</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li><code>git config --global core.symlinks true</code>：克隆一个包含子模块和符号链接的存储库。这里是为了兼容 windows，详细的解释请查看 <a target="_blank" rel="noopener noreferrer" href="https://github.community/t/git-bash-symbolic-links-on-windows/522">git bash symbolic links on windows<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><h3 id="2、clone-repository"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#2、clone-repository"><span class="icon icon-link"></span></a>2、Clone repository</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Clone repository</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation">:</span><span class="token plain"> actions/checkout@v2</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 使用 `depth&gt; 1`，因为有时我们需要重新构建 master 分支，如果 checkout 太浅，其他 commits push 之后将不可能重新构建。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">submodules</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li><code>actions/checkout@v2</code>：checkout action 很常用<ul><li><code>fetch-depth: 5</code>：默认情况下，仅提取一次提交。这里设置的 5，就会提取最近的 5 次提交。</li><li><code>submodules: true</code>：构建需要把子模块也获取到，Deno 中包含了子模块。</li></ul></li></ul><h3 id="3、create-source-tarballs-release-linux"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#3、create-source-tarballs-release-linux"><span class="icon icon-link"></span></a>3、Create source tarballs (release, linux)</h3><blockquote><p>创建源文件压缩包 (release, linux)</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Create source tarballs (release</span><span class="token punctuation">,</span><span class="token plain"> linux)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    startsWith(matrix.os, &#x27;ubuntu&#x27;) &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    startsWith(github.ref, &#x27;refs/tags/&#x27;)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    mkdir -p target/release</span></div><div class="token-line"><span class="token scalar string">    tar --exclude=.cargo_home --exclude=&quot;.git*&quot; --exclude=target --exclude=third_party/prebuilt -czvf target/release/deno_src.tar.gz -C .. deno</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 os 是 <code>&#x27;ubuntu&#x27;</code>、kind 是 <code>&#x27;test_release&#x27;</code>、仓库是 <code>&#x27;denoland/deno&#x27;</code>、本地执行 <code>git push --tags</code> 或 <code>git push origin v0.0.1</code></li><li><code>run</code>：其实发 release 的时候会自动打包源文件，这里之所以多打一个，是因为要忽略很多文件夹，打出纯 deno 的源文件</li></ul><h3 id="4、install-rust"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#4、install-rust"><span class="icon icon-link"></span></a>4、Install rust</h3><blockquote><p>安装 rust</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Install rust</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation">:</span><span class="token plain"> hecrj/setup</span><span class="token punctuation">-</span><span class="token plain">rust</span><span class="token punctuation">-</span><span class="token plain">action@v1</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">rust-version</span><span class="token punctuation">:</span><span class="token plain"> 1.49.0</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>Deno 源码是 RUST 编写的，所以是用 <code>hecrj/setup-rust-action@v1</code>，每个语言都有自己的 <code>setup</code>，商店里能搜到 <a target="_blank" rel="noopener noreferrer" href="https://github.com/marketplace?type=actions&amp;query=setup">358<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 条记录。</li></ul><h3 id="5、install-clippy-and-rustfmt"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#5、install-clippy-and-rustfmt"><span class="icon icon-link"></span></a>5、Install clippy and rustfmt</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Install clippy and rustfmt</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;lint&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    rustup component add clippy</span></div><div class="token-line"><span class="token scalar string">    rustup component add rustfmt</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="6、install-deno（非-windows）"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#6、install-deno（非-windows）"><span class="icon icon-link"></span></a>6、Install Deno（非 Windows）</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Install Deno</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    !startsWith(matrix.os, &#x27;windows&#x27;)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token punctuation">-</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    curl </span><span class="token punctuation">-</span><span class="token plain">fsSL https</span><span class="token punctuation">:</span><span class="token plain">//deno.land/x/install/install.sh </span><span class="token punctuation">|</span><span class="token plain"> sh </span><span class="token punctuation">-</span><span class="token plain">s v1.5.1</span></div><div class="token-line"><span class="token plain">    echo &quot;$HOME/.deno/bin&quot; </span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token plain"> $GITHUB_PATH</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 os 不是 windows</li><li><code>run</code><ul><li><code>|-</code> 和 <code>|</code>是 yaml 的语法。这样，您就可以有效地声明多行 yaml 字符串。语法详情查看<a target="_blank" rel="noopener noreferrer" href="https://yaml-multiline.info/">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><code>curl -fsSL https://deno.land/x/install/install.sh | sh -s v1.5.1</code> 安装 deno（这里应该可以 pr）</li><li><code>echo &quot;$HOME/.deno/bin&quot; &gt;&gt; $GITHUB_PATH</code>：设置环境变量，设置的指向文件系统上某个位置的任何新环境变量都应该有 <code>_PATH</code> 后缀。</li></ul></li></ul><h3 id="7、install-deno-windows"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#7、install-deno-windows"><span class="icon icon-link"></span></a>7、Install Deno (Windows)</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Install Deno (Windows)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> startsWith(matrix.os</span><span class="token punctuation">,</span><span class="token plain"> &#x27;windows&#x27;)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token punctuation">-</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    curl </span><span class="token punctuation">-</span><span class="token plain">fsSL https</span><span class="token punctuation">:</span><span class="token plain">//deno.land/x/install/install.sh </span><span class="token punctuation">|</span><span class="token plain"> sh </span><span class="token punctuation">-</span><span class="token plain">s v1.5.1</span></div><div class="token-line"><span class="token plain">    echo &quot;$HOME/.deno/bin&quot; </span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token plain"> $env</span><span class="token punctuation">:</span><span class="token plain">GITHUB_PATH</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 os 是 windows</li><li><code>run</code>：和上文一样</li></ul><h3 id="8、install-python"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#8、install-python"><span class="icon icon-link"></span></a>8、Install Python</h3><blockquote><p>安装 python</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Install Python</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation">:</span><span class="token plain"> actions/setup</span><span class="token punctuation">-</span><span class="token plain">python@v1</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">python-version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;3.8&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">architecture</span><span class="token punctuation">:</span><span class="token plain"> x64</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="9、install-node"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#9、install-node"><span class="icon icon-link"></span></a>9、Install Node</h3><blockquote><p>安装 Node</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Install Node</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation">:</span><span class="token plain"> actions/setup</span><span class="token punctuation">-</span><span class="token plain">node@v2</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">node-version</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;14&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">check-latest</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="10、remove-unused-versions-of-python"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#10、remove-unused-versions-of-python"><span class="icon icon-link"></span></a>10、Remove unused versions of Python</h3><blockquote><p>删除没有用到的 Python 版本</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Remove unused versions of Python</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> startsWith(matrix.os</span><span class="token punctuation">,</span><span class="token plain"> &#x27;windows&#x27;)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token punctuation">-</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    $env</span><span class="token punctuation">:</span><span class="token plain">PATH </span><span class="token punctuation">-</span><span class="token plain">split &quot;;&quot; </span><span class="token punctuation">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      Where</span><span class="token punctuation">-</span><span class="token plain">Object </span><span class="token punctuation">{</span><span class="token plain"> Test</span><span class="token punctuation">-</span><span class="token plain">Path &quot;$_\python.exe&quot; </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      Select</span><span class="token punctuation">-</span><span class="token plain">Object </span><span class="token punctuation">-</span><span class="token plain">Skip 1 </span><span class="token punctuation">|</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      ForEach</span><span class="token punctuation">-</span><span class="token plain">Object </span><span class="token punctuation">{</span><span class="token plain"> Move</span><span class="token punctuation">-</span><span class="token plain">Item &quot;$_&quot; &quot;$_.disabled&quot; </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="11、setup-gcloud-unix"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#11、setup-gcloud-unix"><span class="icon icon-link"></span></a>11、Setup gcloud (unix)</h3><blockquote><p>安装 Google Cloud SDK（unix）</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Setup gcloud (unix)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    runner.os != &#x27;Windows&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    (github.ref == &#x27;refs/heads/master&#x27; ||</span></div><div class="token-line"><span class="token scalar string">    startsWith(github.ref, &#x27;refs/tags/&#x27;))</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation">:</span><span class="token plain"> google</span><span class="token punctuation">-</span><span class="token plain">github</span><span class="token punctuation">-</span><span class="token plain">actions/setup</span><span class="token punctuation">-</span><span class="token plain">gcloud@master</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">project_id</span><span class="token punctuation">:</span><span class="token plain"> denoland</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">service_account_key</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> secrets.GCP_SA_KEY </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">export_default_credentials</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：运行系统不是 &#x27;Windows&#x27;、构建矩阵 kind 是 <code>&#x27;test_release&#x27;</code>、仓库是 <code>&#x27;denoland/deno&#x27;</code>、分支是 master 或是 tag 提交</li><li><code>google-github-actions/setup-gcloud</code>：与 Google Cloud Platform 交互的 GitHub Actions 的集合。</li></ul><h3 id="12、setup-gcloud-windows"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#12、setup-gcloud-windows"><span class="icon icon-link"></span></a>12、Setup gcloud (windows)</h3><blockquote><p>同 11 作用一样，不过是为 windows 设置 gcloud</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Setup gcloud (windows)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    runner.os == &#x27;Windows&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    (github.ref == &#x27;refs/heads/master&#x27; ||</span></div><div class="token-line"><span class="token scalar string">    startsWith(github.ref, &#x27;refs/tags/&#x27;))</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation">:</span><span class="token plain"> google</span><span class="token punctuation">-</span><span class="token plain">github</span><span class="token punctuation">-</span><span class="token plain">actions/setup</span><span class="token punctuation">-</span><span class="token plain">gcloud@master</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">CLOUDSDK_PYTHON</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain">env.pythonLocation</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain">\python.exe</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">project_id</span><span class="token punctuation">:</span><span class="token plain"> denoland</span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">service_account_key</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> secrets.GCP_SA_KEY </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">export_default_credentials</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="13、configure-canary-build"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#13、configure-canary-build"><span class="icon icon-link"></span></a>13、Configure canary build</h3><blockquote><p>配置 canary 渠道的 build（Deno 发布氛围 canary 和 release 渠道）</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Configure canary build</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.ref == &#x27;refs/heads/master&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">shell</span><span class="token punctuation">:</span><span class="token plain"> bash</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    echo &quot;DENO_CANARY=true&quot; &gt;&gt; $GITHUB_ENV</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 <code>kind</code> 为 <code>&#x27;test_release&#x27;</code>、github repo 是 <code>&#x27;denoland/deno&#x27;</code>、master 分支</li><li><code>run</code> 将 <code>&quot;DENO_CANARY=true&quot;</code> 设置进环境变量。</li></ul><blockquote><p>您也可以使用 <code>GITHUB_ENV</code> environment file 设置工作流程中的以下步骤可以使用的环境变量。 —— 文档</p></blockquote><h3 id="14、log-versions"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#14、log-versions"><span class="icon icon-link"></span></a>14、Log versions</h3><blockquote><p>检查前面安装的程序的版本</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Log versions</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    node -v</span></div><div class="token-line"><span class="token scalar string">    python --version</span></div><div class="token-line"><span class="token scalar string">    rustc --version</span></div><div class="token-line"><span class="token scalar string">    cargo --version</span></div><div class="token-line"><span class="token scalar string">    deno --version</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="15、lintjs"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#15、lintjs"><span class="icon icon-link"></span></a>15、lint.js</h3><blockquote><p>执行 lint</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> lint.js</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;lint&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> deno run </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">unstable </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">allow</span><span class="token punctuation">-</span><span class="token plain">write </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">allow</span><span class="token punctuation">-</span><span class="token plain">read </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">allow</span><span class="token punctuation">-</span><span class="token plain">run ./tools/lint.js</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 <code>kind</code> 类型 为 <code>&#x27;lint&#x27;</code></li></ul><h3 id="16、test_formatjs"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#16、test_formatjs"><span class="icon icon-link"></span></a>16、test_format.js</h3><blockquote><p>测试格式化程序</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> test_format.js</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;lint&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> deno run </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">unstable </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">allow</span><span class="token punctuation">-</span><span class="token plain">write </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">allow</span><span class="token punctuation">-</span><span class="token plain">read </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">allow</span><span class="token punctuation">-</span><span class="token plain">run ./tools/format.js </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">check</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 <code>kind</code> 类型 为 <code>&#x27;lint&#x27;</code></li></ul><h3 id="17、build-release"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#17、build-release"><span class="icon icon-link"></span></a>17、Build release</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Build release</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; ||</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;bench&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> cargo build </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">release </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">locked </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">all</span><span class="token punctuation">-</span><span class="token plain">targets </span><span class="token punctuation">-</span><span class="token plain">vv</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 <code>kind</code> 类型 为 <code>&#x27;test_release&#x27;</code> 或 <code>&#x27;bench&#x27;</code></li></ul><h3 id="18、build-debug"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#18、build-debug"><span class="icon icon-link"></span></a>18、Build debug</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Build debug</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;test_debug&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> cargo build </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">locked </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">all</span><span class="token punctuation">-</span><span class="token plain">targets</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 <code>kind</code> 类型 为 <code>&#x27;test_debug&#x27;</code></li></ul><h3 id="19、pre-release-linux"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#19、pre-release-linux"><span class="icon icon-link"></span></a>19、Pre-release (linux)</h3><blockquote><p>发布之前的准备工作（linux）</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Pre</span><span class="token punctuation">-</span><span class="token plain">release (linux)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    startsWith(matrix.os, &#x27;ubuntu&#x27;) &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    cd target/release</span></div><div class="token-line"><span class="token scalar string">    zip -r deno-x86_64-unknown-linux-gnu.zip deno</span></div><div class="token-line"><span class="token scalar string">    zip -r denort-x86_64-unknown-linux-gnu.zip denort</span></div><div class="token-line"><span class="token scalar string">    ./deno types &gt; lib.deno.d.ts</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 os 为 <code>&#x27;ubuntu&#x27;</code>、构建矩阵 <code>kind</code> 为 <code>&#x27;test_release&#x27;</code></li><li><code>run</code>：做的事情其实就是打压缩包，这些压缩包最终会发布在 GitHub Release 中供安装脚本使用</li></ul><h3 id="20、pre-release-mac"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#20、pre-release-mac"><span class="icon icon-link"></span></a>20、Pre-release (mac)</h3><blockquote><p>和 19 作用一样，这里没有 <code>./deno types &gt; lib.deno.d.ts</code>，私以为漏了。</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Pre</span><span class="token punctuation">-</span><span class="token plain">release (mac)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    startsWith(matrix.os, &#x27;macOS&#x27;) &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    cd target/release</span></div><div class="token-line"><span class="token scalar string">    zip -r deno-x86_64-apple-darwin.zip deno</span></div><div class="token-line"><span class="token scalar string">    zip -r denort-x86_64-apple-darwin.zip denort</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="21、pre-release-windows"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#21、pre-release-windows"><span class="icon icon-link"></span></a>21、Pre-release (windows)</h3><blockquote><p>和 19、20 一样，just for windows，可以学习一下 Windows 下的压缩命令怎么写！</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Pre</span><span class="token punctuation">-</span><span class="token plain">release (windows)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    startsWith(matrix.os, &#x27;windows&#x27;) &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    Compress-Archive -CompressionLevel Optimal -Force -Path target/release/deno.exe -DestinationPath target/release/deno-x86_64-pc-windows-msvc.zip</span></div><div class="token-line"><span class="token scalar string">    Compress-Archive -CompressionLevel Optimal -Force -Path target/release/denort.exe -DestinationPath target/release/denort-x86_64-pc-windows-msvc.zip</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="22、upload-canary-to-dldenoland-unix"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#22、upload-canary-to-dldenoland-unix"><span class="icon icon-link"></span></a>22、Upload canary to dl.deno.land (unix)</h3><blockquote><p>上传 canary 包到 dl.deno.land（unix）(我们只要知道托管在 Google 云就好了)</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Upload canary to dl.deno.land (unix)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    runner.os != &#x27;Windows&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.ref == &#x27;refs/heads/master&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    gsutil cp ./target/release/*.zip gs://dl.deno.land/canary/$(git rev-parse HEAD)/</span></div><div class="token-line"><span class="token scalar string">    echo $(git rev-parse HEAD) &gt; canary-latest.txt</span></div><div class="token-line"><span class="token scalar string">    gsutil cp canary-latest.txt gs://dl.deno.land/canary-latest.txt</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：操作系统不是 Windows、构建矩阵 kind 是 <code>&#x27;test_release&#x27;</code>、github repo 是 <code>&#x27;denoland/deno&#x27;</code>、master 分支</li><li><code>run</code><ul><li><code>gsutil cp ./target/release/*.zip gs://dl.deno.land/canary/$(git rev-parse HEAD)/</code>：上传压缩包到服务器<ul><li><code>$(git rev-parse HEAD)</code>：获取最新的 git commit hash，你可以再任一 git 库中执行 <code>echo $(git rev-parse HEAD)</code> 验证</li></ul></li><li><code>echo $(git rev-parse HEAD) &gt; canary-latest.txt</code>：将 commit hash 值作为版本写入 canary-latest.txt</li><li><code>gsutil cp canary-latest.txt gs://dl.deno.land/canary-latest.txt</code>：上传 <code>canary-latest.txt</code> 到服务器</li></ul></li></ul><h3 id="23、upload-canary-to-dldenoland-windows"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#23、upload-canary-to-dldenoland-windows"><span class="icon icon-link"></span></a>23、Upload canary to dl.deno.land (windows)</h3><blockquote><p>和 22 作用一样，just for windows</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Upload canary to dl.deno.land (windows)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    runner.os == &#x27;Windows&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.ref == &#x27;refs/heads/master&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">CLOUDSDK_PYTHON</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain">env.pythonLocation</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain">\python.exe</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">shell</span><span class="token punctuation">:</span><span class="token plain"> bash</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    gsutil cp ./target/release/*.zip gs://dl.deno.land/canary/$(git rev-parse HEAD)/</span></div><div class="token-line"><span class="token scalar string">    echo $(git rev-parse HEAD) &gt; canary-latest.txt</span></div><div class="token-line"><span class="token scalar string">    gsutil cp canary-latest.txt gs://dl.deno.land/canary-latest.txt</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li><code>CLOUDSDK_PYTHON: $<!-- -->{<!-- -->{<!-- -->env.pythonLocation<!-- -->}<!-- -->}<!-- -->\python.exe</code>：从这里可以看到 Python 环境是给 google cloud sdk 用的</li></ul><h3 id="24、test-release"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#24、test-release"><span class="icon icon-link"></span></a>24、Test release</h3><blockquote><p>测试发布</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Test release</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;test_release&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> cargo test </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">release </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">locked </span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token plain">all</span><span class="token punctuation">-</span><span class="token plain">targets</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="25、test-debug"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#25、test-debug"><span class="icon icon-link"></span></a>25、Test debug</h3><blockquote><p>测试 debug</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Test debug</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;test_debug&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    cargo test --locked --doc</span></div><div class="token-line"><span class="token scalar string">    cargo test --locked --all-targets</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="26、configure-hosts-file-for-wpt-unix"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#26、configure-hosts-file-for-wpt-unix"><span class="icon icon-link"></span></a>26、Configure hosts file for WPT (unix)</h3><blockquote><p>WPT 是 Web Platform Test 的意思，对应仓库 <a target="_blank" rel="noopener noreferrer" href="https://github.com/denoland/wpt">denoland/wpt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"> </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Configure hosts file for WPT (unix)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> runner.os </span><span class="token tag">!=</span><span class="token plain"> &#x27;Windows&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> ./wpt make</span><span class="token punctuation">-</span><span class="token plain">hosts</span><span class="token punctuation">-</span><span class="token plain">file </span><span class="token punctuation">|</span><span class="token plain"> sudo tee </span><span class="token punctuation">-</span><span class="token plain">a /etc/hosts</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">working-directory</span><span class="token punctuation">:</span><span class="token plain"> test_util/wpt/</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="27、configure-hosts-file-for-wpt-windows"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#27、configure-hosts-file-for-wpt-windows"><span class="icon icon-link"></span></a>27、Configure hosts file for WPT (windows)</h3><blockquote><p>和 26 作用一样，just for windows</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Configure hosts file for WPT (windows)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> runner.os == &#x27;Windows&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">working-directory</span><span class="token punctuation">:</span><span class="token plain"> test_util/wpt/</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> python wpt make</span><span class="token punctuation">-</span><span class="token plain">hosts</span><span class="token punctuation">-</span><span class="token plain">file </span><span class="token punctuation">|</span><span class="token plain"> Out</span><span class="token punctuation">-</span><span class="token plain">File $env</span><span class="token punctuation">:</span><span class="token plain">SystemRoot\System32\drivers\etc\hosts </span><span class="token punctuation">-</span><span class="token plain">Encoding ascii </span><span class="token punctuation">-</span><span class="token plain">Append</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="28、run-web-platform-tests-release"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#28、run-web-platform-tests-release"><span class="icon icon-link"></span></a>28、Run web platform tests (release)</h3><blockquote><p>在 web 平台下运行测试（release）</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Run web platform tests (release)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;test_release&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    deno run --unstable --allow-write --allow-read --allow-net --allow-env --allow-run ./tools/wpt.ts setup</span></div><div class="token-line"><span class="token scalar string">    deno run --unstable --allow-write --allow-read --allow-net --allow-env --allow-run ./tools/wpt.ts run --quiet --release</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="29、run-web-platform-tests-debug"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#29、run-web-platform-tests-debug"><span class="icon icon-link"></span></a>29、Run web platform tests (debug)</h3><blockquote><p>在 web 平台下运行测试（debug）</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"> </span><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Run web platform tests (debug)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;test_debug&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    deno run --unstable --allow-write --allow-read --allow-net --allow-env --allow-run ./tools/wpt.ts setup</span></div><div class="token-line"><span class="token scalar string">    deno run --unstable --allow-write --allow-read --allow-net --allow-env --allow-run ./tools/wpt.ts run --quiet</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="30、run-benchmarks"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#30、run-benchmarks"><span class="icon icon-link"></span></a>30、Run Benchmarks</h3><blockquote><p>压力测试</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Run Benchmarks</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;bench&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> cargo bench</span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 kind 为 <code>&#x27;bench&#x27;</code></li></ul><h3 id="31、post-benchmarks"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#31、post-benchmarks"><span class="icon icon-link"></span></a>31、Post Benchmarks</h3><blockquote><p>看起来是把压测数据存到 <code>denoland/benchmark_data</code></p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Post Benchmarks</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;bench&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.ref == &#x27;refs/heads/master&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">DENOBOT_PAT</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> secrets.DENOBOT_PAT </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    git clone --depth 1 -b gh-pages https://${DENOBOT_PAT}@github.com/denoland/benchmark_data.git gh-pages</span></div><div class="token-line"><span class="token scalar string">    deno run --unstable -A ./tools/build_benchmark_jsons.js --release</span></div><div class="token-line"><span class="token scalar string">    cd gh-pages</span></div><div class="token-line"><span class="token scalar string">    git config user.email &quot;propelml@gmail.com&quot;</span></div><div class="token-line"><span class="token scalar string">    git config user.name &quot;denobot&quot;</span></div><div class="token-line"><span class="token scalar string">    git add .</span></div><div class="token-line"><span class="token scalar string">    git commit --message &quot;Update benchmarks&quot;</span></div><div class="token-line"><span class="token scalar string">    git push origin gh-pages</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：<code>denoland/deno</code> 库的 master 分支且构建矩阵的 kind 是 <code>&#x27;bench&#x27;</code></li></ul><h3 id="32、worker-info"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#32、worker-info"><span class="icon icon-link"></span></a>32、Worker info</h3><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Worker info</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> matrix.kind == &#x27;bench&#x27;</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    cat /proc/cpuinfo</span></div><div class="token-line"><span class="token scalar string">    cat /proc/meminfo</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li>执行条件：构建矩阵 kind 是 <code>bench</code></li><li>run<ul><li><code>cat /proc/cpuinfo</code>：查看 cpu 信息</li><li><code>cat /proc/meminfo</code>：查看内存信息</li></ul></li></ul><h3 id="33、upload-release-to-dldenoland-unix"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#33、upload-release-to-dldenoland-unix"><span class="icon icon-link"></span></a>33、Upload release to dl.deno.land (unix)</h3><blockquote><p>上传 unix release 到 dl.deno.land</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Upload release to dl.deno.land (unix)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    runner.os != &#x27;Windows&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    startsWith(github.ref, &#x27;refs/tags/&#x27;)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    gsutil cp ./target/release/*.zip gs://dl.deno.land/release/${GITHUB_REF#refs/*/}/</span></div><div class="token-line"><span class="token scalar string">    echo ${GITHUB_REF#refs/*/} &gt; release-latest.txt</span></div><div class="token-line"><span class="token scalar string">    gsutil cp release-latest.txt gs://dl.deno.land/release-latest.txt</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="34、upload-release-to-dldenoland-windows"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#34、upload-release-to-dldenoland-windows"><span class="icon icon-link"></span></a>34、Upload release to dl.deno.land (windows)</h3><blockquote><p>上传 windows release 到 dl.deno.land</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Upload release to dl.deno.land (windows)</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    runner.os == &#x27;Windows&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    startsWith(github.ref, &#x27;refs/tags/&#x27;)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">CLOUDSDK_PYTHON</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain">env.pythonLocation</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain">\python.exe</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">shell</span><span class="token punctuation">:</span><span class="token plain"> bash</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">run</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    gsutil cp ./target/release/*.zip gs://dl.deno.land/release/${GITHUB_REF#refs/*/}/</span></div><div class="token-line"><span class="token scalar string">    echo ${GITHUB_REF#refs/*/} &gt; release-latest.txt</span></div><div class="token-line"><span class="token scalar string">    gsutil cp release-latest.txt gs://dl.deno.land/release-latest.txt</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><h3 id="35、upload-release-to-github"><a aria-hidden="true" tabindex="-1" href="/blog/deno/deno git-hub action 源码解析#35、upload-release-to-github"><span class="icon icon-link"></span></a>35、Upload release to GitHub</h3><blockquote><p>上传 release 到 GitHub</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-yml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation">:</span><span class="token plain"> Upload release to GitHub</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation">:</span><span class="token plain"> softprops/action</span><span class="token punctuation">-</span><span class="token plain">gh</span><span class="token punctuation">-</span><span class="token plain">release@v1</span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">    matrix.kind == &#x27;test_release&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    github.repository == &#x27;denoland/deno&#x27; &amp;&amp;</span></div><div class="token-line"><span class="token scalar string">    startsWith(github.ref, &#x27;refs/tags/&#x27;)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span><span class="token plain"> $</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">files</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">|</span><span class="token scalar string"></span></div><div class="token-line"><span class="token scalar string">      target/release/deno-x86_64-pc-windows-msvc.zip</span></div><div class="token-line"><span class="token scalar string">      target/release/deno-x86_64-unknown-linux-gnu.zip</span></div><div class="token-line"><span class="token scalar string">      target/release/deno-x86_64-apple-darwin.zip</span></div><div class="token-line"><span class="token scalar string">      target/release/deno_src.tar.gz</span></div><div class="token-line"><span class="token scalar string">      target/release/lib.deno.d.ts</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">draft</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div></pre></div><ul><li><code>softprops/action-gh-release@v1</code>：发布 github release 用的 action，这个确实很棒，可以执行直接上传 release asset 等高级操作。我在 <a target="_blank" rel="noopener noreferrer" href="https://github.com/youngjuning/tuya-panel-demo/blob/master/.github/workflows/release.yml">tuya-panel-demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中使用了该插件。</li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/youngjuning/youngjuning.github.io/edit/main/docs/blog/deno/Deno GitHub Action 源码解析.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">3/8/2021 11:47:52</span></div></div><div class="ant-back-top"></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.3431d731.js"></script>
  </body>
</html>
